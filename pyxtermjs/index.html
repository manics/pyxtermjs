<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>pyxterm.js</title>
  <link rel="stylesheet" href="https://unpkg.com/xterm@4.11.0/css/xterm.css" />
  <script src="https://unpkg.com/xterm@4.11.0/lib/xterm.js"></script>
  <script src="https://unpkg.com/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.js"></script>
  <script src="https://unpkg.com/xterm-addon-web-links@0.4.0/lib/xterm-addon-web-links.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
  <style>
    html {
      font-family: sans-serif;
    }

    html,
    body {
      height: 100%;
    }

    #terminal {
      height: calc(100% - 50px);
    }

    #status {
      font-size: small;
    }

    #status.connected {
      color: green;
    }

    #status.disconnected {
      color: red;
    }
  </style>
</head>

<body>
  <div id="terminal"></div>
  <span id="status" class="disconnected">Connecting...</span>

  <script>
    const term = new Terminal({
      cursorBlink: true,
      macOptionIsMeta: true,
      scrollback: true,
    });
    // https://github.com/xtermjs/xterm.js/issues/2941
    const fit = new FitAddon.FitAddon();
    term.loadAddon(fit);
    term.loadAddon(new WebLinksAddon.WebLinksAddon());

    term.open(document.getElementById('terminal'));
    fit.fit();
    console.log(`Terminal size: ${term.cols} x ${term.rows}`);

    term.write('Hello from \x1B[1;3;31mxterm.js\x1B[0m $ ')

    term.onKey((key, ev) => {
      console.log("pressed key", key);
      console.log("event", ev);
      socket.emit("pty-input", { "input": key });
    });

    const socket = io.connect('/pty', {"path": window.location.pathname + "socket.io"});
    const status = document.getElementById("status");

    socket.on("pty-output", function (data) {
      console.log("new output", data);
      term.write(data.output);
    });

    socket.on("connect", () => {
      fitToscreen();
      status.textContent = "connected";
      status.className = "connected";
    });

    socket.on("disconnect", () => {
      status.textContent = "disconnected";
      status.className = "disconnected";
    });

    function fitToscreen() {
      fit.fit();
      console.log(`Terminal size: ${term.cols} x ${term.rows}`);
      socket.emit("resize", { "cols": term.cols, "rows": term.rows });
    }

    function debounce(func, wait_ms) {
      let timeout
      return function (...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait_ms);
      }
    }

    const wait_ms = 50;
    window.onresize = debounce(fitToscreen, wait_ms);

    // run initial commands from cmd query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const cmd = urlParams.get('cmd');
    if (cmd) {
      term.writeln(cmd);
      socket.emit("pty-input", { "input": { "string": cmd + '\n' } });
    }

  </script>
</body>

</html>